#!/usr/bin/env sh
set -eu

# Determine OS
UNAME=$(uname -s 2>/dev/null || echo unknown)
case "$UNAME" in
  Linux*)  MACHINE=Linux ;;
  Darwin*) MACHINE=MacOS ;;
  *)       MACHINE=UNKNOWN ;;
esac

# Get dotfiles directory
DOTFILES_DIR=$(cd "$(dirname "$0")" && pwd)

# Ensure base config dirs exist
mkdir -p "$HOME/.config" "$HOME/.config/nvim" "$HOME/.config/ghostty" "$HOME/.config/zellij"

####################
# Git
####################

ln -sfv "$DOTFILES_DIR/.gitconfig" "$HOME/.gitconfig"
if [ -f "$DOTFILES_DIR/.gitignore_global" ]; then
  ln -sfv "$DOTFILES_DIR/.gitignore_global" "$HOME/.gitignore_global"
fi
if [ -f "$DOTFILES_DIR/.gitconfig-linux" ] && [ "$MACHINE" = "Linux" ]; then
  ln -sfv "$DOTFILES_DIR/.gitconfig-linux" "$HOME/.gitconfig-linux"
fi
if [ -f "$DOTFILES_DIR/.gitconfig-macos" ] && [ "$MACHINE" = "MacOS" ]; then
  ln -sfv "$DOTFILES_DIR/.gitconfig-macos" "$HOME/.gitconfig-macos"
fi

####################
# ZSH / Shell
####################

ln -sfv "$DOTFILES_DIR/.zshrc" "$HOME/.zshrc"
ln -sfv "$DOTFILES_DIR/.zsh_exports" "$HOME/.zsh_exports"
ln -sfv "$DOTFILES_DIR/.zsh_aliases" "$HOME/.zsh_aliases"
# Optional: only link if present in the repo
if [ -f "$DOTFILES_DIR/.dircolors" ]; then
  ln -sfv "$DOTFILES_DIR/.dircolors" "$HOME/.dircolors"
fi

# Starship
ln -sfv "$DOTFILES_DIR/starship.toml" "$HOME/.config/starship.toml"
if ! command -v starship >/dev/null 2>&1; then
  curl -fsSL https://starship.rs/install.sh | sh -s -- -y
fi

####################
# Editors / Neovim
####################

ln -sfv "$DOTFILES_DIR/init.lua" "$HOME/.config/nvim/init.lua"

####################
# Terminal: Ghostty (kitty removed)
####################

# If a Ghostty config exists in the repo, link it to standard locations
if [ -f "$DOTFILES_DIR/ghostty" ]; then
  # XDG location (Linux and generally supported)
  ln -sfv "$DOTFILES_DIR/ghostty" "$HOME/.config/ghostty/config"

  # macOS native location
  if [ "$MACHINE" = "MacOS" ]; then
    MAC_GHOSTTY_DIR="$HOME/Library/Application Support/com.mitchellh.ghostty"
    mkdir -p "$MAC_GHOSTTY_DIR"
    ln -sfv "$DOTFILES_DIR/ghostty" "$MAC_GHOSTTY_DIR/config"
  fi
fi

# Ensure Catppuccin Mocha theme is installed for Ghostty
GHOSTTY_THEME_DIR="$HOME/.config/ghostty/themes"
GHOSTTY_THEME_FILE="$GHOSTTY_THEME_DIR/catppuccin-mocha.conf"
CATPPUCCIN_MOCHA_URL="https://raw.githubusercontent.com/catppuccin/ghostty/refs/heads/main/themes/catppuccin-mocha.conf"
mkdir -p "$GHOSTTY_THEME_DIR"
if [ ! -f "$GHOSTTY_THEME_FILE" ]; then
  echo "Installing Ghostty theme: catppuccin-mocha"
  if command -v curl >/dev/null 2>&1; then
    curl -fsSL "$CATPPUCCIN_MOCHA_URL" -o "$GHOSTTY_THEME_FILE"
  elif command -v wget >/dev/null 2>&1; then
    wget -q -O "$GHOSTTY_THEME_FILE" "$CATPPUCCIN_MOCHA_URL"
  else
    echo "Warning: neither curl nor wget found; cannot download Ghostty theme." >&2
  fi
fi

# On macOS, also expose the theme under the native Ghostty config dir for completeness
if [ "$MACHINE" = "MacOS" ]; then
  MAC_GHOSTTY_DIR="$HOME/Library/Application Support/com.mitchellh.ghostty"
  MAC_GHOSTTY_THEME_DIR="$MAC_GHOSTTY_DIR/themes"
  mkdir -p "$MAC_GHOSTTY_THEME_DIR"
  # Symlink to the XDG theme file so it's kept up-to-date
  if [ -f "$GHOSTTY_THEME_FILE" ]; then
    ln -sfv "$GHOSTTY_THEME_FILE" "$MAC_GHOSTTY_THEME_DIR/catppuccin-mocha.conf"
  fi
fi

####################
# Zellij
####################

# Link Zellij config from ./zellij -> ~/.config/zellij/config.kdl
if [ -f "$DOTFILES_DIR/zellij" ]; then
  ln -sfv "$DOTFILES_DIR/zellij" "$HOME/.config/zellij/config.kdl"
fi

####################
# lazygit
####################

# Link lazygit config:
# - macOS: ~/Library/Application Support/lazygit/config.yml
# - Linux: ~/.config/lazygit/config.yml (existing logic)
if [ -f "$DOTFILES_DIR/lazygit.yml" ]; then
  if [ "$MACHINE" = "MacOS" ]; then
    MAC_LG_DIR="$HOME/Library/Application Support/lazygit"
    mkdir -p "$MAC_LG_DIR"
    ln -sfv "$DOTFILES_DIR/lazygit.yml" "$MAC_LG_DIR/config.yml"
  else
    mkdir -p "$HOME/.config/lazygit"
    ln -sfv "$DOTFILES_DIR/lazygit.yml" "$HOME/.config/lazygit/config.yml"
  fi
fi

####################
# VS Code (optional)
####################

# if [ ! -d "$HOME/.config/Code/User" ]; then mkdir -p "$HOME/.config/Code/User"; fi
# ln -sfv "$DOTFILES_DIR/vscode/settings.json" "$HOME/.config/Code/User/settings.json"

####################
# Desktop tweaks (Linux only)
####################

if [ "$MACHINE" = "Linux" ]; then
  # Detect a local desktop session (avoid remote/VPS)
  # Prefer XDG_CURRENT_DESKTOP / DESKTOP_SESSION; fall back to DISPLAY / WAYLAND_DISPLAY
  if [ -n "${XDG_CURRENT_DESKTOP:-}" ] || [ -n "${DESKTOP_SESSION:-}" ] || [ -n "${WAYLAND_DISPLAY:-}" ] || [ -n "${DISPLAY:-}" ]; then
    # Run gsettings only when available
    if command -v gsettings >/dev/null 2>&1; then
      gsettings set org.gnome.desktop.wm.keybindings switch-to-workspace-5 '["<Alt>5"]' || true
      gsettings set org.gnome.desktop.wm.keybindings move-to-workspace-5 '["<Shift><Alt>5"]' || true
      gsettings set org.gnome.shell.app-switcher current-workspace-only true || true
    fi

    # Install Nordzy icon theme (idempotent)
    mkdir -p "$HOME/src"
    if [ ! -d "$HOME/src/Nordzy-icon" ]; then
      git clone https://github.com/alvatip/Nordzy-icon "$HOME/src/Nordzy-icon"
    fi
    (cd "$HOME/src/Nordzy-icon" && ./install.sh) || true
  fi
fi
